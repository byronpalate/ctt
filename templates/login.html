{% extends "basebs.html" %}
//holaaa
{% block extracss %}
<link rel="stylesheet" href="/static/css/jquery.fancybox.css?v={{ institucion.versionstaticscss }}" type="text/css" media="screen" />
<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
<style>
    .swiper-container {
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .swiper-slide img {
        width: 100%;
        height: auto;
        object-fit: contain;
    }

    #news-gallery {
        max-width: 800px;
        margin: 0 auto 2rem;
    }

    .form-login {
        background: #fff;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .form-login h3 {
        color: #2c3e50;
        margin-bottom: 1.5rem;
        font-weight: 600;
        text-align: center;
    }

    .alert {
        border-radius: 6px;
    }

    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
        width: 100%;
        padding: 0.6rem;
    }

    .news-container .alert {
        border-left: 4px solid #3498db;
        border-radius: 4px;
    }

    .news-container .alert-danger {
        border-left-color: #e74c3c;
    }

    .news-container .alert-heading {
        font-size: 1.2rem;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .col-md-4 {
            margin-top: 2rem;
        }
    }
</style>
{% endblock %}

{% block heading %}
<script type="text/javascript" src="/static/js/jquery.fancybox.pack.js?v={{ institucion.versionstaticsjs }}"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Swiper initialization
    var totalSlides = document.querySelectorAll('.swiper-slide').length;
    var breakpointsConfig = {
        640: {
            slidesPerView: 1,
            spaceBetween: 20,
        }
    };

    if (totalSlides === 2) {
        breakpointsConfig[768] = {
            slidesPerView: 2,
            spaceBetween: 30,
        };
    }

    var mySwiper = new Swiper('.swiper-container', {
        loop: true,
        slidesPerView: 'auto',
        spaceBetween: 30,
        autoplay: {
            delay: 5000,
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        breakpoints: breakpointsConfig
    });

    // Fancybox configuration
    $.fancybox.open($('.swiper-container'), {
        loop: true,
        afterShow: function() {
            mySwiper.update();
        },
        baseClass: 'myFancybox',
        smallBtn: true,
        toolbar: false,
        touch: {
            vertical: false,
        },
    });

    // Client info collection
    function collectClientInfo() {
        var unknown = '-';
        var screenSize = '';

        if (screen.width) {
            width = (screen.width) ? screen.width : '';
            height = (screen.height) ? screen.height : '';
            screenSize += '' + width + " x " + height;
        }

        // Browser detection
        var nVer = navigator.appVersion;
        var nAgt = navigator.userAgent;
        var browser = navigator.appName;
        var version = '' + parseFloat(navigator.appVersion);
        var majorversion = parseInt(navigator.appVersion, 10);
        var nameOffset, verOffset, ix;

        // Browser detection logic
        if ((verOffset = nAgt.indexOf('Opera')) !== -1) {
            browser = 'Opera';
            version = nAgt.substring(verOffset + 6);
            if ((verOffset = nAgt.indexOf('Version')) !== -1) {
                version = nAgt.substring(verOffset + 8);
            }
        } else if ((verOffset = nAgt.indexOf('OPR')) !== -1) {
            browser = 'Opera';
            version = nAgt.substring(verOffset + 4);
        } else if ((verOffset = nAgt.indexOf('MSIE')) !== -1) {
            browser = 'Microsoft Internet Explorer';
            version = nAgt.substring(verOffset + 5);
        } else if ((verOffset = nAgt.indexOf('Chrome')) !== -1) {
            browser = 'Chrome';
            version = nAgt.substring(verOffset + 7);
        } else if ((verOffset = nAgt.indexOf('Safari')) !== -1) {
            browser = 'Safari';
            version = nAgt.substring(verOffset + 7);
            if ((verOffset = nAgt.indexOf('Version')) !== -1) {
                version = nAgt.substring(verOffset + 8);
            }
        } else if ((verOffset = nAgt.indexOf('Firefox')) !== -1) {
            browser = 'Firefox';
            version = nAgt.substring(verOffset + 8);
        } else if (nAgt.indexOf('Trident/') !== -1) {
            browser = 'Microsoft Internet Explorer';
            version = nAgt.substring(nAgt.indexOf('rv:') + 3);
        } else if ((nameOffset = nAgt.lastIndexOf(' ') + 1) < (verOffset = nAgt.lastIndexOf('/'))) {
            browser = nAgt.substring(nameOffset, verOffset);
            version = nAgt.substring(verOffset + 1);
            if (browser.toLowerCase() === browser.toUpperCase()) {
                browser = navigator.appName;
            }
        }

        // Version trimming
        if ((ix = version.indexOf(';')) !== -1) version = version.substring(0, ix);
        if ((ix = version.indexOf(' ')) !== -1) version = version.substring(0, ix);
        if ((ix = version.indexOf(')')) !== -1) version = version.substring(0, ix);

        majorversion = parseInt('' + version, 10);
        if (isNaN(majorversion)) {
            version = '' + parseFloat(navigator.appVersion);
            majorversion = parseInt(navigator.appVersion, 10);
        }

        // Mobile detection
        var mobile = /Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);

        // Cookie detection
        var cookieEnabled = (navigator.cookieEnabled);
        if (typeof navigator.cookieEnabled === 'undefined' && !cookieEnabled) {
            document.cookie = 'testcookie';
            cookieEnabled = (document.cookie.indexOf('testcookie') !== -1);
        }

        // OS detection
        var os = unknown;
        var clientStrings = [
            {s:'Windows 10', r:/(Windows 10.0|Windows NT 10.0)/},
            {s:'Windows 8.1', r:/(Windows 8.1|Windows NT 6.3)/},
            {s:'Windows 8', r:/(Windows 8|Windows NT 6.2)/},
            {s:'Windows 7', r:/(Windows 7|Windows NT 6.1)/},
            {s:'Windows Vista', r:/Windows NT 6.0/},
            {s:'Windows Server 2003', r:/Windows NT 5.2/},
            {s:'Windows XP', r:/(Windows NT 5.1|Windows XP)/},
            {s:'Windows 2000', r:/(Windows NT 5.0|Windows 2000)/},
            {s:'Windows ME', r:/(Win 9x 4.90|Windows ME)/},
            {s:'Windows 98', r:/(Windows 98|Win98)/},
            {s:'Windows 95', r:/(Windows 95|Win95|Windows_95)/},
            {s:'Windows NT 4.0', r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},
            {s:'Windows CE', r:/Windows CE/},
            {s:'Windows 3.11', r:/Win16/},
            {s:'Android', r:/Android/},
            {s:'Open BSD', r:/OpenBSD/},
            {s:'Sun OS', r:/SunOS/},
            {s:'Linux', r:/(Linux|X11)/},
            {s:'iOS', r:/(iPhone|iPad|iPod)/},
            {s:'Mac OS X', r:/Mac OS X/},
            {s:'Mac OS', r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},
            {s:'QNX', r:/QNX/},
            {s:'UNIX', r:/UNIX/},
            {s:'BeOS', r:/BeOS/},
            {s:'OS/2', r:/OS\/2/},
            {s:'Search Bot', r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}
        ];

        for (var id in clientStrings) {
            var cs = clientStrings[id];
            if (cs.r.test(nAgt)) {
                os = cs.s;
                break;
            }
        }

        var osVersion = unknown;

        if (/Windows/.test(os)) {
            osVersion = /Windows (.*)/.exec(os)[1];
            os = 'Windows';
        }

        switch (os) {
            case 'Mac OS X':
                osVersion = /Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];
                break;
            case 'Android':
                osVersion = /Android ([\.\_\d]+)/.exec(nAgt)[1];
                break;
            case 'iOS':
                osVersion = /OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);
                osVersion = osVersion[1] + '.' + osVersion[2] + '.' + (osVersion[3] | 0);
                break;
        }

        return {
            screen: screenSize,
            browser: browser,
            browserVersion: version,
            browsermajorversion: majorversion,
            mobile: mobile,
            os: os,
            osVersion: osVersion,
            cookies: cookieEnabled
        };
    }

    var clientInfo = collectClientInfo();
    var navegador = clientInfo.browser + ' ' + clientInfo.browsermajorversion;
    var os = clientInfo.os + ' ' + clientInfo.osVersion;
    var screensize = clientInfo.screen;

    // Form handling
    $("#password, #user, #datos").css({'text-transform': 'none'});
    $("#user").focus();

    $("#user").blur(function(){
        $(this).val($(this).val().trim());
    });

    $("#pass, #user").keydown(function(){
        $("#errormensaje").hide();
    });

    $("#login").click(function(){
        login();
    });

    $("#recuperar").click(function(){
        $("#loginform").hide();
        $("#tabla").hide();
        $('#datos').val('');
        $("#recuperarform").show();
        $("#datos").focus();
    });

    $("#ingresar").click(function(){
        $('#user').val($('#correocuenta').attr('nombrecuenta'));
        $("#recuperarform").hide();
        $("#loginform").show();
        $("#user").focus();
    });

    $("#busquedacancel").click(function(){
        $("#recuperarform").hide();
        $("#loginform").show();
        $("#user").focus();
    });

    function buscar(){
        var busqueda = $("#datos").val();
        $("#errorb").hide();
        if (busqueda.trim().length > 0) {
            bloqueointerface();
            $.ajax({
                type: "POST",
                url: "/datos",
                data: {"action": "busqueda", "busqueda": busqueda, 'csrfmiddlewaretoken': csrftoken},
                success: function (data) {
                    desbloqueointerface();
                    if (data.result === "ok") {
                        $("#tabla").show();
                        $("#correocuenta").html(data.email).attr({'nombrecuenta': data.user});
                    } else {
                        $("#tabla").hide();
                        $("#errorb").html('No existen datos para esta consulta').show();
                    }
                },
                error: function(){
                    desbloqueointerface();
                    $("#tabla").hide();
                    $("#errorb").html('No se pudo realizar la consulta').show();
                },
                dataType:"json"
            });
        } else {
            $("#datos").focus();
        }
    }

    $("#busqueda").click(function(){
        buscar();
    });

    $("#cambioclave").click(function(){
        var elemento = $("#correocuenta");
        var usuario = elemento.attr('nombrecuenta');
        $("#errorb, #success").hide();
        if (usuario.trim().length > 0) {
            bloqueointerface();
            $.ajax({
                type: "POST",
                url: "/datos",
                data: {"action": "generarnuevaclave", "usuario": usuario, 'csrfmiddlewaretoken': csrftoken},
                success: function (data) {
                    desbloqueointerface();
                    if (data.result === "ok") {
                        $("#tabla").hide();
                        $('#user').val(usuario);
                        $("#recuperarform").hide();
                        $("#loginform").show();
                        $("#errormensaje").html('Revise su email para completar la solicitud.').show();
                    } else {
                        $("#errorb").html(data.mensaje).show();
                    }
                },
                error: function(){
                    desbloqueointerface();
                    NotificacionError('!!!', 'Error de conexión');
                },
                dataType:"json"
            });
        } else {
            $("#datos").focus();
        }
    });

    function login(){
        var usuario = $("#user").val();
        var clave = $("#password").val();
        if (usuario.length === 0){
            $("#user").focus();
        } else if (clave.length === 0){
            $("#password").focus();
        } else {
            bloqueointerface();
            $("#login").attr({"disabled": "disabled"});
            $.ajax({
                type: "POST",
                url: "/login",
                data: {'action': 'login', 'navegador': navegador, 'os': os, 'screensize': screensize, 'user': usuario, 'pass': clave, 'csrfmiddlewaretoken': csrftoken},
                success: function(data) {
                    if (data.result === 'ok') {
                        localStorage.clear();
                        localStorage.setItem('sessionid', data.sessionid);
                        window.name = data.sessionid;
                        chequearsesionid = true;
                        sysend.broadcast('ctt', {message: 'inicio', token: data.sessionid});
                        location.href = "/";
                    } else {
                        desbloqueointerface();
                        $("#errormensaje").html(data.mensaje).show();
                    }
                },
                error: function() {
                    desbloqueointerface();
                    $("#errormensaje").html('Error al enviar los datos').show();
                },
                dataType: "json"
            });
        }
    }

    $('#user, #password').keyup(function(e) {
        if(e.keyCode === 13) {
            login();
        }
    });

    $('#datos').keyup(function(e) {
        if(e.keyCode === 13) {
            buscar();
        }
    });

    // Auto-trigger fancybox for first item
    $(".fancybox").eq(0).trigger('click');
});
</script>
{% endblock %}

{% block contentextraclass %}bg{{ background }}{% endblock %}
{% block pagetitle %}Inicio de Sesión - Sistema Gestión Académica{% endblock %}

{% block canvas %}
{% if noticiasgraficas %}
<div id="news-gallery">
    <div class="swiper-container">
        <div class="swiper-wrapper">
            {% for noticia in noticiasgraficas %}
            <div class="swiper-slide">
                <a href="{{ noticia.imagen.download_link }}" data-fancybox="gallery">
                    <img src="{{ noticia.imagen.download_link }}" alt="{{ noticia.titulo }}">
                </a>
            </div>
            {% endfor %}
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
    </div>
</div>
{% endif %}

<div class="container py-4">
    <div class="row">
        <div class="col-md-8 news-container">
            {% for noticia in noticias %}
            <div class="alert {% if noticia.tipo == 2 %}alert-danger{% else %}alert-info{% endif %} mb-4">
                <h4 class="alert-heading">{{ noticia.titular }}</h4>
                {% autoescape on %}
                {{ noticia.cuerpo|safe|urlize }}
                {% endautoescape %}
            </div>
            {% endfor %}
        </div>

        <div class="col-md-4">
            <form class="form-login" id="loginform">
                <h3>Entrada al CTT</h3>
                <div class="mb-3">
                    <div class="alert alert-danger" id="errormensaje" style="display: none"></div>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="user" placeholder="Nombre de usuario">
                    <label for="user">Nombre de usuario</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" placeholder="Contraseña">
                    <label for="password">Contraseña</label>
                </div>
                <div class="mb-3">
                    <button id="login" class="btn btn-success" type="button">
                        <i class="icon-arrow-right"></i> Entrar
                    </button>
                </div>
                <div class="mt-4 text-center">
                    <p>En caso de problemas, contactar al <a href="mailto:{{ contacto_email }}">administrador</a></p>
                    <p>¿Olvidó su usuario o contraseña? <a href="javascript:;" id="recuperar">Consultar aquí</a></p>
                </div>
            </form>

            <form class="form-login" id="recuperarform" style="display: none">
                <h3>Recuperar Acceso</h3>
                <div class="alert alert-danger" id="errorb" style="display: none"></div>
                <div class="alert alert-success" id="success" style="display: none"></div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="datos" placeholder="Ingrese su identificación">
                    <label for="datos">Ingrese su identificación</label>
                </div>
                <div class="mb-3 d-flex justify-content-between">
                    <button class="btn btn-info" type="button" id="busqueda">Buscar</button>
                    <button class="btn btn-secondary" type="button" id="busquedacancel">Cancelar</button>
                </div>
                <div class="mb-3 mt-4" style="display: none" id="tabla">
                    <div class="alert alert-info">
                        <p>Estimado usuario(a), hemos enviado el nombre de su usuario al correo: <b><span class="text-danger" id="correocuenta" nombrecuenta=""></span></b></p>
                        <p>Si no recuerda su clave, puede generar una nueva que será enviada a su correo registrado.</p>
                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-primary" type="button" id="ingresar">Ingresar</button>
                            <button class="btn btn-success" type="button" id="cambioclave">Generar clave</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
