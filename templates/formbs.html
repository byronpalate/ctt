{% extends form.form_base %}
{% load ctt_extras %}
{% block form %}
    <div id="formbs"></div>
    <div id="ajaxformdinamicbs_{{ session_key }}" hidden></div>
    <div id="ajaxformwidth" hidden>ajaxformwidth_{{ form.fields.formwidth.initial }}</div>
    <form action="javascript:;" method="post" id="formulario3" {% block formtagextra %}{% endblock %} style="width: 100%; margin-bottom: 0; ">
        {% block formextra %}{% endblock %}
        {% block formprefix %}{% endblock %}
        {% if form.fields.formtype.initial  == 'horizontal' %}
            {% for field in form %}
                {% with form.section_titles|get_item:field.name as section_title %}
                    {% if section_title %}
                        <div class="control-group"
                             id="fieldset_titulo_{{ field.name }}"
                             style="display:none;">
                            <h4 class="mt-3 mb-2">{{ section_title }}</h4>
                            <hr>
                        </div>
                    {% endif %}
                {% endwith %}
                {% if not field.field.widget.is_hidden %}
                    <div class="mb-1 row" id="fieldset_{{ field.name }}">
                        <label for="id_{{ field.name }}" style="font-size: 13px;" class="col-sm-3 col-form-label">{{ field.label }}</label>
                        <div class="col-sm-9" style="{% if field.field.widget.input_type == 'checkbox' %}display: block;{% endif %} align-items: center;">
                            {% if not field.field.widget.attrs.select2search %}
                                {{ field }}
                            {% else %}
                                <select id="id_{{ field.name }}_select2" {% if field.field.widget.attrs.disabled %}disabled=""{% endif %} class="select2">
                                    <option value="" selected="selected">---------</option>
                                </select>
                                <input hidden type="text" name="{{ field.name }}" id="id_{{ field.name }}" value="{% if field.field.widget.attrs.va %}{{ field.field.widget.attrs.va }}{% else %}{{ field.value }}{% endif %}" {% if field.field.widget.attrs.descripcion %}descripcion="{{ field.field.widget.attrs.descripcion }}"{% endif %} class="select2hidden">
                            {% endif %}
                            <p class="help-text" alert="{% if field.field.widget.attrs.help_text %}{{ field.field.widget.attrs.help_text }}{% else %}{{ field.help_text }}{% endif %}" style="font-size: small; margin-bottom: 0;float: left; width: 100%"><span style='color: #0e90d2'>{% if field.field.widget.attrs.help_text %}{{ field.field.widget.attrs.help_text }}{% else %}{{ field.help_text }}{% endif %}</span></p>
                            {#                        <p class="help-text" alert="{% if field.field.widget.attrs.help_text %}{{ field.field.widget.attrs.help_text }}{% else %}{{ field.help_text }}{% endif %}" style="font-size: small; margin-bottom: 0; height: 13px; line-height: 13px; float: left; width: 100%"><span style='color: #0e90d2'>{% if field.field.widget.attrs.help_text %}{{ field.field.widget.attrs.help_text }}{% else %}{{ field.help_text }}{% endif %}</span></p>#}
                        </div>
                    </div>
                {% else %}
                    <div class="mb-1 row" id="fieldset_{{ field.name }}" style="display: none">
                        <label for="id_{{ field.name }}" style="font-size: 13px;" class="col-sm-3 col-form-label">{{ field.label }}</label>
                        <div class="col-sm-9">
                            {{ field }}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            {% for field in form %}
                {% if not field.field.widget.is_hidden %}
                    <div class="mb-1 row-fluid" id="fieldset_{{ field.name }}">
                        <div class="row-fluid">
                            <label for="id_{{ field.name }}" style="font-size: 13px;" class="col-sm-3 col-form-label">{{ field.label }}</label>
                        </div>
                        <div class="row-fluid">
                            <div class="col-sm-12">
                                {% if not field.field.widget.attrs.select2search %}
                                    {{ field }}
                                {% else %}
                                    <select id="id_{{ field.name }}_select2" {% if field.field.widget.attrs.disabled %}disabled=""{% endif %} class="select2">
                                        <option value="" selected="selected">---------</option>
                                    </select>
                                    <input hidden type="text" name="{{ field.name }}" id="id_{{ field.name }}" value="{% if field.field.widget.attrs.va %}{{ field.field.widget.attrs.va }}{% else %}{{ field.value }}{% endif %}" {% if field.field.widget.attrs.descripcion %}descripcion="{{ field.field.widget.attrs.descripcion }}"{% endif %} class="select2hidden">
                                {% endif %}
                                <p class="help-text" alert="{% if field.field.widget.attrs.help_text %}{{ field.field.widget.attrs.help_text }}{% else %}{{ field.help_text }}{% endif %}" style="font-size: small; margin-bottom: 0;float: left; width: 100%"><span style='color: #0e90d2'>{% if field.field.widget.attrs.help_text %}{{ field.field.widget.attrs.help_text }}{% else %}{{ field.help_text }}{% endif %}</span></p>
                                {#                        <p class="help-text" alert="{% if field.field.widget.attrs.help_text %}{{ field.field.widget.attrs.help_text }}{% else %}{{ field.help_text }}{% endif %}" style="font-size: small; margin-bottom: 0; height: 13px; line-height: 13px; float: left; width: 100%"><span style='color: #0e90d2'>{% if field.field.widget.attrs.help_text %}{{ field.field.widget.attrs.help_text }}{% else %}{{ field.help_text }}{% endif %}</span></p>#}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="mb-1 row-fluid" id="fieldset_{{ field.name }}" style="display: none">
                        <div class="row-fluid">
                            <label for="id_{{ field.name }}" style="font-size: 13px;" class="col-sm-3 col-form-label">{{ field.label }}</label>
                        </div>
                        <div class="row-fluid">
                            <div class="col-sm-12">
                                {{ field }}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        {% block formsuffix %}
        {% endblock %}
    </form>
{% endblock %}
{% block buttonsform %}
    {% block preextrabuttons %}
    {% endblock %}
    {% if permite_modificar %}
        <a href="javascript:;" class="btn btn-sm btn-success" id="formbutton">{% block buttonname %}Guardar{% endblock %}</a>
    {% endif %}
    {% block extrabuttons %}
    {% endblock %}
    {% if puede_ver_botoncancelar %}
        <a href="javascript:;" id="formcancelbutton" nhref="{% block formback %}/{% endblock %}" class="btn btn-sm {% if permite_modificar %}btn-danger{% else %}btn-success{% endif %}">{% if permite_modificar %}Cancelar{% else %}Aceptar{% endif %}</a>
    {% endif %}
    {% if puede_ver_botonsalir %}
        <a href="javascript:;" id="formsalirbutton" class="btn btn-sm btn-danger btn-success"> Salir </a>
    {% endif %}
{% endblock %}
{% block javascript %}
    <script type="text/javascript">
        var destino = "{% block formdestination %}/{% endblock %}";
        var cargardestino = true;
        var desbloquearformulario = true;
        var cerrarformulario = true;
        var script_formulario = true;
        $(function() {
            $(".selectorfecha").datepicker({format:"dd-mm-yyyy"});
            /*

            $("form").validationEngine({validateNonVisibleFields: true, autoHidePrompt:true, autoHideDelay:1000 });

            $("#cerrarmensajeform").click(function () {
                bloqueointerface();
                location.href = destino;
            });

            $(":file").filestyle({"input": false});

            eliminar_alertas();

            $('.group-span-filestyle').css({'margin-left': '0'});

*/
            actualizar_campos_select2 = function () {
                $(".select2hidden").each(function () {
                    var id = $(this).attr("id");
                    if ($(this).attr('descripcion')){
                        $("#"+id+"_select2").html('<option selected="selected">'+$(this).attr("descripcion")+'</option>');
                        $("#select2-"+id+"_select2-container").html('<span>'+$(this).attr("descripcion")+'</span><span class="select2-selection__clear">×</span>');
                    }else{
                        $("#"+id+"_select2").html('<option>---------</option>');
                        $("#select2-"+id+"_select2-container").html('<span>---------</span>');
                    }
                });
            };

            limpiar_select2 = function(nombre){
                $("#" + nombre).val('').empty();
                $("#" + nombre + "_select2").val('').trigger("change");
            };

            inicializar_campos_select2 = function () {
                $(".select2hidden ").each(function () {
                    var id = $(this).attr("id");
                    if ($(this).val() > 0){

                    } else {
                        limpiar_select2($(this).attr("id"));
                    }
                });
            };

            multiselect_validation = function () {
                $(".custom-multiselect").find('input').unbind();
                $(".custom-multiselect").find('input').bind("click", function () {
                    var cantidad = $('input:checked[name='+$(this).attr('basename')+']').length;
                    $("#id_"+$(this).attr('basename')+"_validacion").val((cantidad?"1":"")).attr({'value':(cantidad?"1":"")});
                });
                $(".inputmultiselect").each(function () {
                    var cantidad = $('input:checked[name='+$(this).attr('basename')+']').length;
                    $(this).val((cantidad?"1":"")).attr({'value':(cantidad?"1":"")});
                });

                $(".busqueda_multiselect").unbind();
                $(".busqueda_multiselect").keyup(function(){
                    var id = $(this).attr('ide');
                    var s = $(this).val().toUpperCase();
                    $(".contenido_"+id).show();

                    if (s.length > 0){
                        $(".contenido_"+id).each(function () {
                            if (!$(this).text().contains(s)){
                                $(this).hide();
                            }
                        });
                    }
                });
            };
            multiselect_validation();

            $('textarea').css({'text-transform': 'uppercase'});
            $('input[type=text]').addClass('form-control form-control-sm');
            $('select').addClass('form-select form-select-sm');
            $(':file').each(function(){
                if ($(this).attr('type') === 'file'){
                    var padreextensionaceptada = $(this).parent();
                    if (padreextensionaceptada.attr('filetypes')){
                        var tiposextensionesaceptadas = '';
                        var tiposextensionesaceptadas2 = '';
                        var listatiposextensionesaceptadas = padreextensionaceptada.attr('filetypes').replace('[', '').replace(']', '').split(',');
                        for(elemento in listatiposextensionesaceptadas){
                            tiposextensionesaceptadas2 += '.'+(listatiposextensionesaceptadas[elemento].replace("'", "").replace("'", "").replace(".", "")).trim() + ',';
                            tiposextensionesaceptadas += (listatiposextensionesaceptadas[elemento].replace("'", "").replace("'", "").replace(".", "")).trim() + '|';
                        }
                        $(this).addClass("validate[checkFileType["+tiposextensionesaceptadas.substr(0,tiposextensionesaceptadas.length-1)+"]]").attr({'accept': tiposextensionesaceptadas2});
                    }
                }
            });

            {% if not permite_modificar %}
                $("#formulario3").find("select, textarea, input").each(function() {
                    $(this).attr({'disabled': 'disabled'});
                });
            {% endif %}

            eliminar_alertas = function(){
                setInterval(function() {
                    $('.help-text').each(function () {
                        if ($(this).attr('alert')){
                            $(this).html($(this).attr('alert'));
                        } else {
                            $(this).empty();
                        }
                    });
                }, 800000);
                desbloqueointerface();
            };

            eliminar_alertas();

            envioformulario = function(){
                var valid = $("form").validationEngine('validate');
                if (valid){
                    $('.datepicker').css({"display": "none"});
                    $('.bootstrap-timepicker-widget').css({"display": "none"});
                    bloqueointerface();
                    $('.controls input').each(function(){
                        if ($(this).attr('type') === 'text'){
                            $(this).val($(this).val().trim());
                        }
                        if ($(this).attr('type') !== 'file'){
                            if ($(this).css('text-transform') === 'uppercase'){
                                if ($(this).attr('type') !== 'password'){
                                    $(this).val($(this).val().toUpperCase());
                                }
                            }
                        }
                    });
                    var formdata = new FormData($("#formulario3")[0]);
                    try {
                        pre_envio_formulario();
                    } catch (err){
                        console.log(err.message);
                    }
                    try {
                        formdata.append("lista_items1", JSON.stringify(lista_items1));
                    } catch (err){
                        console.log(err.message);
                    }
                    try {
                        formdata.append("csrfmiddlewaretoken", csrftoken);
                    } catch (err){
                        console.log(err.message);
                    }
                    try {
                        formdata.append("lista_items2", JSON.stringify(lista_items2));
                    } catch (err){
                        console.log(err.message);
                    }
                    try {
                        formdata.append("lista_items3", JSON.stringify(lista_items3));
                    } catch (err){
                        console.log(err.message);
                    }
                    if (script_formulario){
                        $.ajax({
                            type: "POST",
                            url: "{% block formaction %}/{% endblock %}",
                            data: formdata,
                            success: function(data) {
                                if (data.result === 'ok') {
                                    if (destino.endsWith('id=')){
                                        try {
                                            destino +=((data.idnew)?data.idnew:"");
                                        } catch (err){
                                            console.log(err.message);
                                        }
                                        try {
                                            destino +=((data.id)?data.id:"");
                                        } catch (err){
                                            console.log(err.message);
                                        }
                                        if (destino.endsWith('id=')){
                                            destino = destino.substring(0, destino.length - 4)
                                        }
                                    }

                                    if (data.mensaje){
                                        desbloqueointerface();
                                        $("#textmensajeform").html(data.mensaje);
                                        $("#mensajeform").modal('show');
                                    } else {
                                        if (cargardestino){
                                            if (data.reloadpage){
                                                sysend.broadcast('ctt', {message: 'reload', token: data.sessionid});
                                            }
                                            location.href = destino;
                                        }else{
                                            if (desbloquearformulario) {
                                                desbloqueointerface();
                                            }
                                            if (cerrarformulario){
                                                $("#formulariomodaldinamico").html('');
                                                $('#formulariomodaldinamico').modal('hide');
                                            }
                                            try {
                                                post_formulario(data);
                                            } catch (err){
                                                console.log(err.message);
                                            }
                                        }
                                    }
                                } else {
                                    desbloqueointerface();
                                    {#notificamos campos que en el form que son requeridos#}
                                    if (data.errors){
                                        mostrarErroresFormulario(data.errors);
                                    }else{
                                        NotificacionAlerta(data.icono, data.titulo, data.mensaje)
                                    }
                                }
                            },
                            error: function() {
                                desbloqueointerface();
                                NotificacionError('Opss..!!', 'Error de conexión')
                            },
                            dataType: "json",
                            cache: false,
                            contentType: false,
                            processData: false
                        });
                    }
                } else {
                    eliminar_alertas();
                }
            };

            $("#formbutton").click(function(){
                envioformulario();
            });

        });
    </script>
    {% block extrajavascript %}
    {% endblock %}
{% endblock %}